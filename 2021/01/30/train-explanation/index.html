<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Welcome to my personal blogs">
    <meta name="author" content="Yuxuan Wu">
    
    <title>
        
            train explanation |
        
        Yuxuan Wu
    </title>
    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":false},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep coding, Keep hungry."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.3.1"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days age","week":"%s weeks age","month":"%s months age","year":"%s years age"};
  </script>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            <a class="logo-title" href="/">
                Yuxuan Wu
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content normal-code-theme">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">train explanation</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Yuxuan Wu</span>
                        <span class="level">Lv4</span>
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i> 2021-01-30 18:12:35
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>
            <ul>
                
                    <li>
                        <a href="/categories/FYP/">FYP</a>
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>
            <ul>
                
                    <li>
                        <a href="/tags/tutorial/">tutorial</a>
                    </li>
                
                    <li>
                        | <a href="/tags/Multi-instance-learning/">Multi-instance learning</a>
                    </li>
                
                    <li>
                        | <a href="/tags/TF/">TF</a>
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i> <span>1.6k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i> <span>9 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i> <span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p><strong>Notes and required knowledge</strong></p>
<p><code>pickle objects</code>: <a class="link"   target="_blank" rel="noopener" href="https://docs.python.org/3/library/pickle.html" >https://docs.python.org/3/library/pickle.html<i class="fas fa-external-link-alt"></i></a></p>
<blockquote>
<p>The <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pickle.html#module-pickle"><code>pickle</code></a> module implements binary protocols for serializing and de-serializing a Python object structure. <em>“Pickling”</em> is the process whereby a Python object hierarchy is converted into a byte stream, and <em>“unpickling”</em> is the inverse operation, whereby a byte stream (from a binary file or bytes-like object) is converted back into an object hierarchy. Pickling (and unpickling) is alternatively known as “serialization”, “marshalling,” or “flattening”; however, to avoid confusion, the terms used here are “pickling” and “unpickling”.</p>
</blockquote>
<p><code>allow_pickle = True</code>: not to compress or lose the data. (The data was saved by our own, so there was no security problems). </p>
<blockquote>
<p>Allow loading pickled object arrays stored in npy files. Reasons for disallowing pickles include security, as loading pickled data can execute arbitrary code. If pickles are disallowed, loading object arrays will fail. Default: False</p>
</blockquote>
<p><code>npy format</code></p>
<blockquote>
<p>The <code>.npy</code> format is the standard binary file format in NumPy for persisting a <em>single</em> arbitrary NumPy array on disk. The format stores all of the shape and dtype information necessary to reconstruct the array correctly even on another machine with a different architecture. The format is designed to be as simple as possible while achieving its limited goals.</p>
<ul>
<li>No need to reshape, load as you save</li>
<li>Save size small and read file fast</li>
</ul>
</blockquote>
<p><a class="link"   target="_blank" rel="noopener" href="https://numpy.org/devdocs/reference/generated/numpy.lib.format.html#:~:text=npy%20format%20is%20the%20standard,machine%20with%20a%20different%20architecture" >https://numpy.org/devdocs/reference/generated/numpy.lib.format.html#:~:text=npy%20format%20is%20the%20standard,machine%20with%20a%20different%20architecture<i class="fas fa-external-link-alt"></i></a>.</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://towardsdatascience.com/what-is-npy-files-and-why-you-should-use-them-603373c78883" >https://towardsdatascience.com/what-is-npy-files-and-why-you-should-use-them-603373c78883<i class="fas fa-external-link-alt"></i></a></p>
<p><code>tertools.zip_longest()</code></p>
<blockquote>
<p>This iterator falls under the category of <a class="link"   target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/python-itertools/#terminate" >Terminating Iterators<i class="fas fa-external-link-alt"></i></a>. It prints the values of iterables alternatively in sequence. If one of the iterables is printed fully, the remaining values are filled by the values assigned to fill value parameter.</p>
</blockquote>
<p><code>from_generator</code></p>
<blockquote>
<p>The <code>generator</code> argument must be a callable object that returns an object that supports the <code>iter()</code> protocol (e.g. a generator function).</p>
<p>The elements generated by <code>generator</code> must be compatible with either the given <code>output_signature</code> argument or with the given <code>output_types</code> and (optionally) <code>output_shapes</code> arguments, whichiver was specified.</p>
<p>The recommended way to call <code>from_generator</code> is to use the <code>output_signature</code> argument. In this case the output will be assumed to consist of objects with the classes, shapes and types defined by <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/TypeSpec"><code>tf.TypeSpec</code></a> objects from <code>output_signature</code> argument:</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python code to demonstrate the working of   </span></span><br><span class="line"><span class="comment"># zip_longest()  </span></span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> itertools  </span><br><span class="line">    </span><br><span class="line"><span class="comment"># using zip_longest() to combine two iterables.  </span></span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;The combined values of iterables is  : &quot;</span>)  </span><br><span class="line"><span class="built_in">print</span> (*(itertools.zip_longest(<span class="string">&#x27;GesoGes&#x27;</span>, <span class="string">&#x27;ekfrek&#x27;</span>, fillvalue =<span class="string">&#x27;_&#x27;</span> )))  </span><br><span class="line"></span><br><span class="line">------------------------------------</span><br><span class="line"></span><br><span class="line">The combined values of iterables <span class="keyword">is</span>  : </span><br><span class="line">(<span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;e&#x27;</span>) (<span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;k&#x27;</span>) (<span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;f&#x27;</span>) (<span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) (<span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;e&#x27;</span>) (<span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;k&#x27;</span>) (<span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;_&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><code>the shape of list</code>:</p>
<blockquote>
<p>You need to use np.array([..]) to transform the list into array format, then use the shape</p>
</blockquote>
<blockquote>
<p> <code>TensorShape</code>: represents a possibly-partial shape specification for a <code>Tensor</code>. It may be one of the following:</p>
<ul>
<li><em>Fully-known shape:</em> has a known number of dimensions and a known size for each dimension. e.g. <code>TensorShape([16, 256])</code></li>
<li>Partially-known shape:* has a known number of dimensions, and an unknown size for one or more dimension. e.g. <code>TensorShape([None, 256])</code></li>
<li><em>Unknown shape:</em> has an unknown number of dimensions, and an unknown size in all dimensions. e.g. <code>TensorShape(None)</code></li>
</ul>
</blockquote>
<p><code>batch</code></p>
<blockquote>
<p>Combines consecutive elements of this dataset into batches.</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dataset = tf.data.Dataset.<span class="built_in">range</span>(<span class="number">8</span>)</span><br><span class="line">dataset = dataset.batch(<span class="number">3</span>)</span><br><span class="line"><span class="built_in">list</span>(dataset.as_numpy_iterator())</span><br><span class="line">-----------------------------------</span><br><span class="line">[array([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>]),array([<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>],array(<span class="number">6</span>,<span class="number">7</span>))]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dataset = tf.data.Dataset.<span class="built_in">range</span>(<span class="number">8</span>)</span><br><span class="line">dataset = dataset.batch(<span class="number">3</span>, drop_remainder=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">list</span>(dataset.as_numpy_iterator())</span><br><span class="line">-----------------------------------</span><br><span class="line">[array([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>]),array([<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])</span><br><span class="line"> </span><br></pre></td></tr></table></figure>


<p><code>batch&amp;shuffle:</code></p>
<blockquote>
<p>Tensorflow.Dataset中map，shuffle，repeat，batch的总结 </p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/anshuai_aw1/article/details/105094548" >https://blog.csdn.net/anshuai_aw1/article/details/105094548<i class="fas fa-external-link-alt"></i></a></p>
<p>shuffle的顺序很重要，应该先shuffle再batch，如果先batch后shuffle的话，那么此时就只是对batch进行shuffle，而batch里面的数据顺序依旧是有序的，那么随机程度会减弱</p>
<p>buffer_size 越大，打乱的程度越高</p>
</blockquote>
<p><code>tf.function</code></p>
<blockquote>
<table>
<thead>
<tr>
<th>func</th>
<th>the function to be compiled. If func is None, tf.function returns a decorator that can be invoked with a single argument - func. In other words, tf.function(input_signature=…)(func) is equivalent to tf.function(func, input_signature=…). The former can be used as decorator.</th>
</tr>
</thead>
<tbody><tr>
<td>input_signature</td>
<td>A possibly nested sequence of <strong>tf.TensorSpec</strong> objects specifying the shapes and dtypes of the Tensors that will be supplied to this function. If None, a separate function is instantiated for each inferred input signature. If input_signature is specified, every input to func must be a Tensor, and func cannot accept **kwargs.</td>
</tr>
</tbody></table>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apply_gradients(</span><br><span class="line">    grads_and_vars, name=<span class="literal">None</span>, experimental_aggregate_gradients=<span class="literal">True</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<table>
<thead>
<tr>
<th align="left">Args</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>grads_and_vars</code></td>
<td>List of (gradient, variable) pairs.</td>
</tr>
<tr>
<td align="left"><code>name</code></td>
<td>Optional name for the returned operation. Default to the name passed to the <code>Optimizer</code> constructor.</td>
</tr>
<tr>
<td align="left"><code>experimental_aggregate_gradients</code></td>
<td>Whether to sum gradients from different replicas in the presense of <code>tf.distribute.Strategy</code>. If False, it’s user responsibility to aggregate the gradients. Default to True.</td>
</tr>
</tbody></table>
</blockquote>
<hr>
<h3 id="The-code-part"><a href="#The-code-part" class="headerlink" title="The code part:"></a>The code part:</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> net_fun <span class="keyword">import</span> WSCNN, WSCNNLSTM, WeakRM, WeakRMLSTM</span><br><span class="line"><span class="keyword">from</span> utils_fun <span class="keyword">import</span> create_folder</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;CUDA_DEVICE_ORDER&quot;</span>] = <span class="string">&quot;PCI_BUS_ID&quot;</span>  <span class="comment"># see issue #152</span></span><br><span class="line">os.environ[<span class="string">&quot;CUDA_VISIBLE_DEVICES&quot;</span>] = <span class="string">&quot;5&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tfk = tf.keras</span><br><span class="line">tfkl = tf.keras.layers</span><br><span class="line">tfkc = tf.keras.callbacks</span><br><span class="line"></span><br><span class="line">instance_len = <span class="number">40</span></span><br><span class="line">instance_stride = <span class="number">5</span></span><br><span class="line">data_name = <span class="string">&#x27;HIV-1&#x27;</span></span><br><span class="line">model_name = <span class="string">&#x27;WeakRM&#x27;</span></span><br><span class="line"></span><br><span class="line">data_dir = <span class="string">&#x27;/home/yuxuan/FYP/Virus_init_codes/Store/data_for_mil/&#x27;</span></span><br><span class="line">target_dir = data_dir + <span class="string">&#x27;cp_dir/&#x27;</span></span><br><span class="line">create_folder(target_dir)</span><br><span class="line">checkpoint_filepath = target_dir + model_name + <span class="string">&#x27;.h5&#x27;</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;loading data&#x27;</span>)</span><br><span class="line">train_data = np.load(data_dir + <span class="string">&#x27;train_data.npy&#x27;</span>, allow_pickle=<span class="literal">True</span>)</span><br><span class="line">valid_data = np.load(data_dir + <span class="string">&#x27;valid_data.npy&#x27;</span>, allow_pickle=<span class="literal">True</span>)</span><br><span class="line">itest_data = np.load(data_dir + <span class="string">&#x27;test_data.npy&#x27;</span>, allow_pickle=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">train_label = np.load(data_dir + <span class="string">&#x27;train_label.npy&#x27;</span>, allow_pickle=<span class="literal">True</span>)</span><br><span class="line">valid_label = np.load(data_dir + <span class="string">&#x27;valid_label.npy&#x27;</span>, allow_pickle=<span class="literal">True</span>)</span><br><span class="line">itest_label = np.load(data_dir + <span class="string">&#x27;test_label.npy&#x27;</span>, allow_pickle=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## To prepare and combine the train, test, validation sample</span></span><br><span class="line"><span class="comment">## Some test or trail could be turn to file_read.py for details</span></span><br><span class="line">train_dataset = tf.data.Dataset.from_generator(<span class="keyword">lambda</span>: itertools.zip_longest(train_data, train_label),</span><br><span class="line">                                               output_types=(tf.float32, tf.int32),</span><br><span class="line">                                               output_shapes=(tf.TensorShape([<span class="literal">None</span>, instance_len, <span class="number">4</span>]),</span><br><span class="line">                                                              tf.TensorShape([<span class="literal">None</span>])))</span><br><span class="line">valid_dataset = tf.data.Dataset.from_generator(<span class="keyword">lambda</span>: itertools.zip_longest(valid_data, valid_label),</span><br><span class="line">                                               output_types=(tf.float32, tf.int32),</span><br><span class="line">                                               output_shapes=(tf.TensorShape([<span class="literal">None</span>, instance_len, <span class="number">4</span>]),</span><br><span class="line">                                                              tf.TensorShape([<span class="literal">None</span>])))</span><br><span class="line">itest_dataset = tf.data.Dataset.from_generator(<span class="keyword">lambda</span>: itertools.zip_longest(itest_data, itest_label),</span><br><span class="line">                                               output_types=(tf.float32, tf.int32),</span><br><span class="line">                                               output_shapes=(tf.TensorShape([<span class="literal">None</span>, instance_len, <span class="number">4</span>]),</span><br><span class="line">                                                              tf.TensorShape([<span class="literal">None</span>])))</span><br><span class="line"></span><br><span class="line"><span class="comment"># batch set to one to feed the model one by one</span></span><br><span class="line">train_dataset = train_dataset.shuffle(<span class="number">100</span>).batch(<span class="number">1</span>)</span><br><span class="line">valid_dataset = valid_dataset.batch(<span class="number">1</span>)</span><br><span class="line">itest_dataset = itest_dataset.batch(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;creating model&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(model_name, <span class="built_in">str</span>):</span><br><span class="line">    dispatcher = &#123;<span class="string">&#x27;WeakRM&#x27;</span>: WeakRM,</span><br><span class="line">                  <span class="string">&#x27;WeakRMLSTM&#x27;</span>: WeakRMLSTM&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        model_funname = dispatcher[model_name]</span><br><span class="line">    <span class="keyword">except</span> KeyError:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&#x27;invalid input&#x27;</span>)</span><br><span class="line"></span><br><span class="line">model = model_funname()</span><br><span class="line"></span><br><span class="line"><span class="comment"># lr = tf.keras.optimizers.schedules.ExponentialDecay(1e-4, decay_steps=len(train_label), decay_rate=0.96)</span></span><br><span class="line"><span class="comment"># opt = tf.keras.optimizers.Adam(learning_rate=lr)</span></span><br><span class="line">opt = tf.keras.optimizers.Adam(lr=<span class="number">5e-4</span>, beta_1=<span class="number">0.9</span>, beta_2=<span class="number">0.999</span>, epsilon=<span class="number">1e-8</span>, decay=<span class="number">1e-5</span>)</span><br><span class="line"></span><br><span class="line">train_loss = tf.keras.metrics.Mean()</span><br><span class="line">valid_loss = tf.keras.metrics.Mean()</span><br><span class="line">train_auROC = tf.keras.metrics.AUC()</span><br><span class="line">valid_auROC = tf.keras.metrics.AUC()</span><br><span class="line"></span><br><span class="line"><span class="comment">## Specify the input size, None stands for undertermined shape</span></span><br><span class="line">train_step_signature = [</span><br><span class="line">    tf.TensorSpec(shape=(<span class="number">1</span>, <span class="literal">None</span>, instance_len, <span class="number">4</span>), dtype=tf.float32),</span><br><span class="line">    tf.TensorSpec(shape=(<span class="number">1</span>, <span class="number">1</span>), dtype=tf.int32)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@tf.function(<span class="params">input_signature=train_step_signature</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train_step</span>(<span class="params">train_seq, train_label</span>):</span></span><br><span class="line">    <span class="keyword">with</span> tf.GradientTape() <span class="keyword">as</span> tape:</span><br><span class="line">        output_probs, _ = model(train_seq, training=<span class="literal">True</span>)</span><br><span class="line">        loss = tf.keras.losses.BinaryCrossentropy(from_logits=<span class="literal">False</span>)(y_true=train_label, y_pred=output_probs)</span><br><span class="line">        total_loss = loss + tf.reduce_sum(model.losses)</span><br><span class="line">        gradients = tape.gradient(total_loss, model.trainable_variables)</span><br><span class="line">        opt.apply_gradients(<span class="built_in">zip</span>(gradients, model.trainable_variables))</span><br><span class="line">        train_loss(loss)</span><br><span class="line">        train_auROC(y_true=train_label, y_pred=output_probs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@tf.function(<span class="params">input_signature=train_step_signature</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">valid_step</span>(<span class="params">valid_seq, valid_label</span>):</span></span><br><span class="line">    inf_probs, _ = model(valid_seq, training=<span class="literal">False</span>)</span><br><span class="line">    vloss = tf.keras.losses.BinaryCrossentropy()(y_true=valid_label, y_pred=inf_probs)</span><br><span class="line">    valid_loss(vloss)</span><br><span class="line">    valid_auROC(y_true=valid_label, y_pred=inf_probs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EPOCHS = <span class="number">20</span></span><br><span class="line">current_monitor = np.inf</span><br><span class="line">patient_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> tf.<span class="built_in">range</span>(<span class="number">1</span>, EPOCHS+<span class="number">1</span>):</span><br><span class="line">    train_loss.reset_states()</span><br><span class="line">    valid_loss.reset_states()</span><br><span class="line"></span><br><span class="line">    train_auROC.reset_states()</span><br><span class="line">    valid_auROC.reset_states()</span><br><span class="line"></span><br><span class="line">    epoch_start_time = time.time()</span><br><span class="line">    <span class="keyword">for</span> tdata <span class="keyword">in</span> train_dataset:</span><br><span class="line">        train_step(tdata[<span class="number">0</span>], tdata[<span class="number">1</span>])</span><br><span class="line">    print(<span class="string">&#x27;Training of epoch &#123;&#125; finished! Time cost is &#123;&#125;s&#x27;</span>.<span class="built_in">format</span>(epoch, <span class="built_in">round</span>(time.time() - epoch_start_time, <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line">    valid_start_time = time.time()</span><br><span class="line">    <span class="keyword">for</span> vdata <span class="keyword">in</span> valid_dataset:</span><br><span class="line">        valid_step(vdata[<span class="number">0</span>], vdata[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    new_valid_monitor = np.<span class="built_in">round</span>(valid_loss.result().numpy(), <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span> new_valid_monitor &lt; current_monitor:</span><br><span class="line">        print(<span class="string">&#x27;val_loss improved from &#123;&#125; to &#123;&#125;, saving model to &#123;&#125;&#x27;</span>.</span><br><span class="line">              <span class="built_in">format</span>(<span class="built_in">str</span>(current_monitor), <span class="built_in">str</span>(new_valid_monitor), checkpoint_filepath))</span><br><span class="line">        model.save_weights(checkpoint_filepath)</span><br><span class="line">        current_monitor = new_valid_monitor</span><br><span class="line">        patient_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&#x27;val_loss did not improved from &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(current_monitor)))</span><br><span class="line">        patient_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> patient_count == <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    template = <span class="string">&quot;Epoch &#123;&#125;, Time Cost: &#123;&#125;s, TL: &#123;&#125;, TROC: &#123;&#125;, VL:&#123;&#125;, VROC: &#123;&#125;&quot;</span></span><br><span class="line">    print(template.<span class="built_in">format</span>(epoch, <span class="built_in">str</span>(<span class="built_in">round</span>(time.time() - valid_start_time, <span class="number">2</span>)),</span><br><span class="line">                          <span class="built_in">str</span>(np.<span class="built_in">round</span>(train_loss.result().numpy(), <span class="number">4</span>)),</span><br><span class="line">                          <span class="built_in">str</span>(np.<span class="built_in">round</span>(train_auROC.result().numpy(), <span class="number">4</span>)),</span><br><span class="line">                          <span class="built_in">str</span>(np.<span class="built_in">round</span>(valid_loss.result().numpy(), <span class="number">4</span>)),</span><br><span class="line">                          <span class="built_in">str</span>(np.<span class="built_in">round</span>(valid_auROC.result().numpy(), <span class="number">4</span>)),</span><br><span class="line">                          )</span><br><span class="line">          )</span><br><span class="line"></span><br><span class="line">model.load_weights(checkpoint_filepath)</span><br><span class="line"></span><br><span class="line">predictions = []</span><br><span class="line"><span class="keyword">for</span> tdata <span class="keyword">in</span> itest_dataset:</span><br><span class="line">    pred, _ = model(tdata[<span class="number">0</span>], training=<span class="literal">False</span>)</span><br><span class="line">    predictions.append(pred.numpy())</span><br><span class="line"></span><br><span class="line">predictions = np.concatenate(predictions, axis=<span class="number">0</span>)</span><br><span class="line">print(<span class="string">&#x27;Test AUC: &#x27;</span>, tf.keras.metrics.AUC()(y_true=itest_label, y_pred=predictions).numpy())</span><br><span class="line">print(<span class="string">&#x27;Test PRC: &#x27;</span>, tf.keras.metrics.AUC(curve=<span class="string">&#x27;PR&#x27;</span>)(y_true=itest_label, y_pred=predictions).numpy())</span><br></pre></td></tr></table></figure>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post title：train explanation</li>
        <li>Post author：Yuxuan Wu</li>
        <li>Create time：2021-01-30 18:12:35</li>
        <li>
            Post link：yuxuanwu17.github.io2021/01/30/train-explanation/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2021/01/31/nba%E4%BC%A4%E7%97%85%E5%88%86%E6%9E%90/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">NBA kaggle analysis</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/01/29/performance_exp/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">performance explanation</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span> -
            
            2021 <i class="fas fa-heart icon-animate"></i> <a href="/">Yuxuan Wu</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count <span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a> | Theme <a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.3.1</a>
        </div>
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-code-part"><span class="nav-number">1.</span> <span class="nav-text">The code part:</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
